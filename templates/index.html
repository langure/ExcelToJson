<html>

<head>
  <title>Recepción de archivos metadatos</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

  <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />
  <!-- CSS only -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css"
    integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">

    <!-- include css/index.css -->
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/index.css') }}">

  <!-- JavaScript Bundle with Popper -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js"
    integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js"
    integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
    crossorigin="anonymous"></script>
</head>

<body class="d-flex flex-column h-100">
  <header class="bg-dark text-white py-3">
  <div class="container">
    <div class="d-flex flex-wrap align-items-center justify-content-between">
      <a href="#" class="navbar-brand fs-4 text-white">
        <i class="bi bi-file-earmark-arrow-up me-2"></i> Generación de Archivos JSON para Metadatos
      </a>
      <ul class="navbar-nav ms-auto">
        </ul>
    </div>
  </div>
</header>

  <button type="button" class="btn btn-primary btn-lg btn-block" onclick="create();" id="button4">
    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="visibility: hidden;"></span>
    Click aquí para generar json desde Google Spreadsheets
  </button>
  <HR>
  <div class="alert alert-primary" role="alert" style="display:none" id="messageArea">

  </div>
  <div class="container">
    <div class="row row-eq-height">
      <div class="col-md-6 offset-md-2">
          <div class="input-container">
            <input type="text" class="input-field" id = "new-sistema-input" placeholder="Nuevo sistema">
            <button class="add-button" onclick="addSistema()">Agregar</button>
          </div>

          <!-- create a button -->
          <div class = "sistemas-container">
                 <button onclick="populateSistemasTable()" class="btn btn-primary ">Click aquí para ver los sistemas disponibles</button>
          <div id="sistemas-table">
          </div>
          </div>
      </div>
      <div class="col-md-3 offset-md-1">
        <div class="btn-group-vertical gap-1" role="group" style="width: 100%;">
          <button type="button" class="btn btn-info btn-lg btn-block" style="margin: 10px;" onclick="metadatos();" disabled id="button1">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="spinner1"
              style="visibility: hidden;"></span>
              <i class="bi bi-download me-2"></i> Metadatos
          </button>
          <button type="button" class="btn btn-info btn-lg btn-block" style="margin: 10px;" onclick="catalogoMetadatosHomologados();"
            disabled id="button2">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="spinner2"
              style="visibility: hidden;"></span>
           <i class="bi bi-download me-2"></i>  Catálogo Metadatos Homologados
          </button>
          <button type="button" class="btn btn-info btn-lg btn-block" style="margin: 10px;" onclick="metadatosNoValidos();" disabled
            id="button3">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="spinner3"
              style="visibility: hidden;"></span>
            <i class="bi bi-download me-2"></i>  Metadatos No Validos
          </button>
        </div>

      </div>
    </div>
  </div>
  <footer class="footer mt-auto py-3 bg-light">
    <div class="container">
      <span class="text-muted">Metadatos - 2022</span>
    </div>
  </footer>
  <script>

  function showMessage(type, message) {
      const messageArea = document.getElementById("messageArea");
      messageArea.classList.remove("alert-primary", "alert-danger", "alert-success");
      messageArea.classList.add(`alert-${type}`);
      messageArea.innerHTML = message;
      messageArea.style.display = "block";
}

    function processSuccess() {
      document.getElementById("spinner1").style.visibility = "hidden";
      document.getElementById("spinner2").style.visibility = "hidden";
      document.getElementById("spinner3").style.visibility = "hidden";
      $('#button1').prop('disabled', false);
      $('#button2').prop('disabled', false);
      $('#button3').prop('disabled', false);
      document.getElementById("messageArea").style.visibility = "visible"
      document.getElementById("messageArea").className = "alert alert-success"
      document.getElementById("messageArea").innerHTML = "Los archivos ya se pueden descargar."
    }

    function processStart() {
      document.getElementById("spinner1").style.visibility = "visible";
      document.getElementById("spinner2").style.visibility = "visible";
      document.getElementById("spinner3").style.visibility = "visible";
      document.getElementById("messageArea").style.display = "block"
      document.getElementById("messageArea").innerHTML = "Cargando el documento, espere por favor."
    }

    function onNewUpload() {
      location.reload();
    }
    function metadatos() {
      window.location.href = "/metadatos"
    }
    function catalogoMetadatosHomologados() {
      window.location.href = "/catalogoMetadatosHomologados"
    }
    function metadatosNoValidos() {
      window.location.href = "/metadatosNoValidos"
    }
    function create() {
      processStart();
      var xhr = new XMLHttpRequest();
      xhr.withCredentials = true;

      xhr.addEventListener("readystatechange", function () {
        if (this.readyState === 4) {
          console.log(this.responseText);
          processSuccess();
        }
      });

      xhr.open("GET", "/create");

      xhr.send();
    }

    function populateSistemasTable() {
      const tableDiv = document.getElementById("sistemas-table");

      // Clear previous table content
      tableDiv.innerHTML = "";

      const xhr = new XMLHttpRequest();
      xhr.open("GET", "/api/sistemas?token=flsldfj399dksdf-fj39fls.vicsla92kdan-mcd83jkksdh", true);

      xhr.onload = function() {
        if (xhr.status === 200) {
          const sistemasData = xhr.responseText.split("|");

          const table = document.createElement("table");
          table.classList.add("table");
          table.classList.add("table-striped");
          table.classList.add("table-sm");
          const thead = document.createElement("thead");
          const tbody = document.createElement("tbody");

          // Header row
          const headerRow = document.createElement("tr");
          ["ID", "Sistema", "Acción"].forEach(headerText => {
            const headerCell = document.createElement("th");
            headerCell.textContent = headerText;
            headerRow.appendChild(headerCell);
          });
          thead.appendChild(headerRow);

          // Data rows with ID, Sistema, and Remove button
        sistemasData.forEach((sistema, index) => {
            const row = document.createElement("tr");
            row.classList.add("align-middle"); // Vertically center content

            [index + 1, sistema].forEach(cellText => {
              const cell = document.createElement("td");
              cell.textContent = cellText;
              cell.classList.add("px-2"); // Reduce horizontal padding
              row.appendChild(cell);
            });

            const buttonCell = document.createElement("td");
            const removeButton = document.createElement("button");
            removeButton.classList.add("btn", "btn-danger", "btn-sm", "py-0");
            removeButton.textContent = "Borrar";
            removeButton.onclick = () => deleteSistema(sistema);
            buttonCell.appendChild(removeButton);
            buttonCell.classList.add("px-2");
            row.appendChild(buttonCell);

            tbody.appendChild(row);
          });

          table.appendChild(thead);
          table.appendChild(tbody);
          tableDiv.appendChild(table);

        } else {
          tableDiv.innerHTML = "<p>Error fetching data</p>";
        }
      };

      xhr.onerror = function() {
        tableDiv.innerHTML = "<p>Error fetching data</p>";
      };

      xhr.send();
}

function deleteSistema(sistema) {
  if (confirm(`Confirmar borrado de sistema: ${sistema}?`)) {
    const url = '/api/deleteSistema?token=flsldfj399dksdf-fj39fls.vicsla92kdan-mcd83jkksdh';
    const formData = new FormData();
    formData.append('sistema', sistema);

    const xhr = new XMLHttpRequest();
    xhr.open("POST", url, true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

    xhr.onload = function() {
      if (xhr.status === 200) {
          const response = JSON.parse(xhr.responseText);
          if (response.success) {
            showMessage("success", response.reason);
          } else {
            showMessage("danger", `Error deleting sistema: ${response.reason}`);
          }
        populateSistemasTable(); // Repopulate the table
      } else {
        console.error("Error deleting sistema:", xhr.statusText);
        showMessage("danger", "Network error deleting sistema.");

      }
    };

    xhr.onerror = function() {
      console.error("Network error deleting sistema.");
    };

    xhr.send(new URLSearchParams(formData).toString());
  } else {
    console.log("Deletion canceled.");
  }
}

function addSistema() {
  const inputField = document.getElementById("new-sistema-input");
  const sistema = inputField.value.trim(); // Get and trim input value

  // Input validation
  if (sistema === "") {
    alert("Por favor ingrese un nombre de sistema.");
    return;
  }

  // Regular expression to allow only English letters and underscores
  const isValid = /^[a-zA-Z_]+$/.test(sistema);
  if (!isValid) {
    alert("El nombre del sistema solo puede contener letras y guiones bajos. No espacios ni caracteres especiales");
    return;
  }

  const url = '/api/createSistema?token=flsldfj399dksdf-fj39fls.vicsla92kdan-mcd83jkksdh';
  const formData = new FormData();
  formData.append('sistema', sistema);

  const xhr = new XMLHttpRequest();
  xhr.open("POST", url, true);
  xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

  xhr.onload = function() {
    if (xhr.status === 200) {
      console.log("Sistema created successfully:", sistema);
      const response = JSON.parse(xhr.responseText);
        if (response.success) {
            showMessage("success", response.reason);
        } else {
            showMessage("danger", `Error creating sistema: ${response.reason}`);
        }

      inputField.value = ""; // Clear the input field
      populateSistemasTable();
    } else {
      const response = JSON.parse(xhr.responseText);
      console.error("Error creating sistema:", xhr.statusText);
        showMessage("danger", `Error creating sistema: ${response.reason}`);
    }
  };

  xhr.onerror = function() {
    console.error("Network error creating sistema.");
  };

  xhr.send(new URLSearchParams(formData).toString());
}


  </script>



</body>

</html>